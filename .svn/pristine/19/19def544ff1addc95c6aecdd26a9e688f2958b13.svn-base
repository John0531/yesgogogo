<template>
  <div>
    <!-- 會員登入 Modal-->
    <div
      class="modal"
      aria-hidden="true"
      aria-labelledby="exampleModalToggleLabel"
      ref="loginDom"
      id="exampleModalToggle"
    >
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-header align-items-end">
            <button
              type="button"
              class="btn-close"
              @click.prevent="closeLoginModal"
            ></button>
          </div>
          <div class="modal-body px-3 px-lg-6">
            <div class="container-fluid">
              <div class="row py-4 align-items-center mb-5 mt-3">
                <div class="col-lg-6">
                  <Form
                    class="form_registration pe-lg-4 pe-md-3"
                    method="POST"
                    v-slot="{ errors }"
                    @submit="login"
                  >
                    <div class="form_detail">
                      <div class="text-center">
                        <img
                          src="../assets/img/yesgo_icon02.svg"
                          alt=""
                          id="logInImage"
                          class="d-block mx-auto"
                        />
                        <span class="registraion">會員登入</span>
                      </div>
                      <div class="row phone">
                        <div class="col-md-12">
                          <label class="form-label">帳號</label>
                          <Field
                            name="新帳號"
                            type="tel"
                            class="form-control"
                            placeholder="請輸入手機號碼，如:0987654352"
                            autoCompleteType="disabled"
                            :rules="isPhone"
                            :class="{ 'is-invalid': errors['新帳號'] }"
                            v-model="newLogin.PhoneNum"
                            autocomplete="off"
                            tabindex="1"
                          />
                          <ErrorMessage
                            name="新帳號"
                            class="invalid-feedback"
                          ></ErrorMessage>
                        </div>
                      </div>
                      <div class="row password">
                        <div class="col-md-12">
                          <label class="form-label">密碼</label>
                          <div id="f">
                            <Field
                              name="登入密碼"
                              type="password"
                              :rules="checkPwdRule"
                              class="form-control form_password"
                              placeholder="請輸入密碼"
                              :class="{
                                'is-invalid': errors['登入密碼']
                              }"
                              v-model.trim="newLogin.SecretCode"
                              tabindex="2"
                            />
                            <ErrorMessage
                              name="登入密碼"
                              class="invalid-feedback"
                            ></ErrorMessage>
                            <a
                              href="#"
                              @click.prevent="
                                isShow = !isShow;
                                pwdCheck(isShow, $event)
                              "
                              class="passwordImage position-absolute d-block"
                            >
                              <img
                                v-if="isShow"
                                src="../assets/img/yesgo_icon26.svg"
                              />
                              <img
                                v-else
                                src="../assets/img/yesgo_icon25.svg"
                              />
                            </a>
                          </div>
                          <div class="d-flex justify-content-between">
                            <div class="form-check">
                              <input
                                class="form-check-input"
                                type="checkbox"
                                id="rememberAccount"
                                v-model="newLogin.RememberMe"
                              />
                              <label
                                class="form-check-label"
                                for="rememberAccount"
                              >
                                記住帳號
                              </label>
                            </div>
                            <a
                              href="#"
                              @click.prevent="toForgetPassword"
                              class="forgot-password"
                            >
                              忘記密碼
                            </a>
                          </div>
                        </div>
                      </div>
                      <div class="row verification">
                        <div class="col-md-12">
                          <label for="inputState" class="form-label"
                            >驗證碼</label
                          >
                          <div class="input-group">
                            <Field
                              name="驗證碼"
                              :class="{ 'is-invalid': errors['驗證碼'] }"
                              autocomplete="off"
                              type="text"
                              class="form-control z-index-10"
                              maxlength="4"
                              tabindex="3"
                              rules="required"
                              v-model="newLogin.Captcha"
                            />
                            <button
                              class="verifyBtn btn border px-3"
                              type="button"
                              @click.prevent="getValidCode"
                            >
                              <img
                                :src="validate.img"
                                id="imgInitNewValidCode"
                                style="width: 100px; height: 30px; margin-right: 8px;"
                              />
                              <img
                                src="../assets/img/yesgo_icon27.svg"
                              />
                            </button>
                            <ErrorMessage name="驗證碼" class="invalid-feedback"></ErrorMessage>
                          </div>
                        </div>
                      </div>
                      <div class="d-flex justify-content-end text-muted fs-7 mb-2">
                        驗證碼不須區分大小寫
                      </div>
                      <div class="row">
                        <div class="col-md-12">
                          <button
                            type="submit"
                            class="btn btn-primary col-md-12 text-white"
                          >
                            登入
                          </button>
                        </div>
                        <div class="col-md-1 ms-auto">
                          <a
                          class="register text-secondary d-flex justify-content-end text-nowrap mt-3"
                          href="#"
                          @click.prevent="toRegister"
                        >
                          註冊
                        </a>
                        </div>
                      </div>
                    </div>
                  </Form>
                </div>
                <!-- 舊會員點此登入 -->
                <div class="col-lg-6 mt-3 mt-lg-0 ps-lg-4 ps-md-3">
                  <div class="member_discount">
                    <a
                      href="#"
                      @click.prevent="getValidCode(), toOldLoginModal()"
                    >
                      <div class="ratio ratio-4x3">
                        <img src="../assets/img/member_03.jpg" />
                      </div>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 舊會員登入 Modal -->
    <div
      class="modal"
      id="exampleModalToggle2"
      ref="oldLoginDom"
    >
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="btn-close"
              @click.prevent="closeOldLoginModal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="container-fluid">
              <div class="row justify-content-center my-5">
                <div class="col-lg-6">
                  <Form
                    class="form_registration"
                    method="POST"
                    v-slot="{ errors }"
                    @submit="oldMemberLogin"
                  >
                    <div class="form_detail">
                      <div class="text-center">
                        <img
                          src="../assets/img/yesgo_icon02.svg"
                          alt=""
                          id="logInImage"
                          class="d-block mx-auto"
                        />
                        <span class="registraion">舊會員登入</span>
                      </div>
                      <div class="row phone">
                        <div class="col-md-12">
                          <label class="form-label">帳號</label>
                          <Field
                            type="text"
                            v-model="oldLogin.Account"
                            class="form-control"
                            :rules="isaccount"
                            :class="{ 'is-invalid': errors['舊帳號'] }"
                            placeholder="請輸入手機號碼/身分證字號/Email"
                            name="舊帳號"
                            autocomplete="off"
                            tabindex="1"
                          ></Field>
                          <ErrorMessage
                            name="舊帳號"
                            class="invalid-feedback"
                          ></ErrorMessage>
                        </div>
                      </div>
                      <div class="row password">
                        <div class="col-md-12">
                          <label class="form-label">密碼</label>
                          <div id="f">
                            <Field
                              name="舊會員登入密碼"
                              type="password"
                              :rules="checkPwdRule"
                              class="form-control form_password"
                              placeholder="請輸入密碼"
                              :class="{
                                'is-invalid': errors['舊會員登入密碼']
                              }"
                              v-model.trim="oldLogin.SecretCode"
                              autocomplete="off"
                              tabindex="2"
                            ></Field>
                            <ErrorMessage
                              name="舊會員登入密碼"
                              class="invalid-feedback"
                            ></ErrorMessage>
                            <a
                              href="#"
                              @click.prevent="
                                isOldShow = !isOldShow;
                                pwdCheck(isOldShow, $event)
                              "
                              class="passwordImage position-absolute d-block"
                            >
                              <img
                                v-if="isOldShow"
                                src="../assets/img/yesgo_icon26.svg"
                              />
                              <img
                                v-else
                                src="../assets/img/yesgo_icon25.svg"
                              />
                            </a>
                          </div>
                          <div class="d-flex justify-content-between">
                            <div class="form-check">
                              <input
                                class="form-check-input"
                                type="checkbox"
                                id="rememberOldAccount"
                                v-model="oldLogin.RememberMe"
                              />
                              <label
                                class="form-check-label"
                                for="rememberOldAccount"
                              >
                                記住帳號
                              </label>
                            </div>
                            <a
                              class="forgot-password"
                              href="#"
                              @click.prevent="toForgetPassword"
                            >
                              忘記密碼
                            </a>
                          </div>
                        </div>
                      </div>
                      <div class="row verification">
                        <div class="col-md-12">
                          <label for="inputState" class="form-label"
                            >驗證碼</label
                          >
                          <div class="input-group">
                            <Field
                              type="text"
                              class="form-control z-index-10"
                              v-model="oldLogin.Captcha"
                              maxlength="4"
                              tabindex="3"
                              autocomplete="off"
                              rules="required"
                              name="驗證碼"
                              :class="{ 'is-invalid': errors['驗證碼'] }"
                            />
                            <button
                              class="verifyBtn btn border"
                              type="button"
                              @click.prevent="getValidCode"
                            >
                              <span></span>
                              <img
                                :src="validate.img"
                                id="imgInitOldValidCode"
                                style="width: 100px; height: 30px; margin-right: 8px;"
                              />
                              <img
                                src="../assets/img/yesgo_icon27.svg"
                              />
                            </button>
                            <ErrorMessage
                              name="驗證碼"
                              class="invalid-feedback"
                            ></ErrorMessage>
                          </div>
                        </div>
                      </div>
                      <div class="d-flex justify-content-end text-muted fs-7 mb-2">
                        驗證碼不須區分大小寫
                      </div>
                      <div class="row">
                        <div class="col-md-12">
                          <button
                            type="submit"
                            class="btn btn-primary col-md-12 text-white"
                          >
                            登入
                          </button>
                        </div>
                      </div>
                    </div>
                  </Form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import member from '../assets/js/member'
import bootstrap from 'bootstrap/dist/js/bootstrap.bundle.js'
import ValidSvc from '../assets/js/validate-service.js'
// import checkToken from '@/assets/js/checkToken.js'

export default {
  data () {
    return {
      myModal: '',
      myOldModal: '',
      isOldShow: true,
      isShow: true,
      validate: {},
      newLogin: {
        PhoneNum: '',
        SecretCode: '',
        Captcha: '',
        ValidTransactionId: '',
        RememberMe: false
      },
      oldLogin: {
        Account: '',
        SecretCode: '',
        Captcha: '',
        ValidTransactionId: '',
        RememberMe: false
      }
    }
  },
  methods: {
    // ? 關閉會員登入modal
    closeLoginModal () {
      this.$store.state.loginModal.hide()
    },
    // ? 關閉舊會員登入modal
    closeOldLoginModal () {
      this.$store.state.oldloginModal.hide()
    },
    // ? 切換為舊會員登入modal
    toOldLoginModal () {
      this.$store.state.loginModal.hide()
      this.$store.state.oldloginModal.show()
    },
    // ? 前往忘記密碼頁
    toForgetPassword () {
      this.$store.state.loginModal.hide()
      this.$store.state.oldloginModal.hide()
      this.$router.push('/forgetpassword')
    },
    // ? 前往註冊頁
    toRegister () {
      this.$store.state.loginModal.hide()
      this.$router.push('/register')
    },
    // ? 密碼切換
    pwdCheck (status, $event) {
      if (status) {
        // 上上個DOM元素
        $event.currentTarget.previousSibling.previousSibling.setAttribute(
          'type',
          'password'
        )
      } else {
        $event.currentTarget.previousSibling.previousSibling.setAttribute(
          'type',
          'text'
        )
      }
    },
    // ? 新會員登入
    async login () {
      if (await member.login('NewLogIn', this.newLogin, this.myModal)) {
        this.$router.go()
      } else {
        this.getValidCode()
      }
    },
    // ? 舊會員登入
    async oldMemberLogin () {
      if (await member.login('OldLogIn', this.oldLogin, this.myOldModal)) {
        this.$router.go()
      } else {
        this.getValidCode()
      }
    },
    // ? 取得圖形驗證碼
    async getValidCode () {
      this.validate = await member.getValidateCode()
      this.newLogin.ValidTransactionId = this.validate.validTransactionId
      this.oldLogin.ValidTransactionId = this.validate.validTransactionId
    },
    //* 檢查密碼格式
    checkPwdRule (password) {
      return ValidSvc.CheckPwd(password)
    },
    //* 手機號碼格式
    isPhone (phoneNum) {
      return ValidSvc.CheckMobileNum(phoneNum)
    },
    //* 舊會員登入驗證(身分證/Email/手機號碼)
    isaccount (Account) {
      const oldAccounts = ValidSvc.CheckAccount(Account)
      if (oldAccounts === 'id') {
        this.oldLogin.Account = this.oldLogin.Account.toUpperCase()
        // ? 告知可以通過此驗證
        return true
      } else {
        return oldAccounts
      }
    }
  },
  mounted () {
    this.getValidCode()
    this.myModal = new bootstrap.Modal(this.$refs.loginDom, { backdrop: 'static' })
    this.myOldModal = new bootstrap.Modal(this.$refs.oldLoginDom, { backdrop: 'static' })
    this.$store.commit('getLoginModal', this.myModal)
    this.$store.commit('getoldLoginModal', this.myOldModal)
    // // ?如果登入Modal為跳出狀態(shown.bs.modal)，在DOM元素中加入屬性data-shown="shown"
    // this.$refs.loginDom.addEventListener('shown.bs.modal', function () {
    //   this.setAttribute('data-shown', 'shown')
    // })
    // // ?如果登入Modal為關閉狀態(hidden.bs.modal)，在DOM元素中加入屬性data-shown="hidden"
    // this.$refs.loginDom.addEventListener('hidden.bs.modal', function () {
    //   this.setAttribute('data-shown', 'hidden')
    // })
  }
}
</script>
